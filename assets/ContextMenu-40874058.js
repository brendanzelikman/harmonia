import{fl as oe,r as u,hg as D,hh as ie,hi as ae,hj as ce,hk as ue,hl as de,dE as le,hm as ge,a5 as he,e$ as A,hn as fe,fh as pe,f7 as Ie,e_ as y,fd as P,ho as H,hp as N,dD as De,fi as me,hq as Te,a6 as $,bD as E,hr as Se,b5 as Ce,hs as ve,b6 as Oe,ht as ye,hu as Pe,hv as we,a7 as _,bb as K,a9 as X,aZ as Z,hw as B,aV as S,aK as be,bc as G,aS as Me,j as M}from"./index-fe048463.js";var ke=function r(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){if(e.constructor!==t.constructor)return!1;var n,s,o;if(Array.isArray(e)){if(n=e.length,n!=t.length)return!1;for(s=n;s--!==0;)if(!r(e[s],t[s]))return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();if(o=Object.keys(e),n=o.length,n!==Object.keys(t).length)return!1;for(s=n;s--!==0;)if(!Object.prototype.hasOwnProperty.call(t,o[s]))return!1;for(s=n;s--!==0;){var i=o[s];if(!r(e[i],t[i]))return!1}return!0}return e!==e&&t!==t};const Re=oe(ke),T=typeof window<"u"?u.useLayoutEffect:u.useEffect;function xe(r,e,t){const[n,s]=u.useState(()=>e(r)),o=u.useCallback(()=>{const i=e(r);Re(n,i)||(s(i),t&&t())},[n,r,t]);return T(o),[n,o]}function He(r,e,t){const[n,s]=xe(r,e,t);return T(function(){const i=r.getHandlerId();if(i!=null)return r.subscribeToStateChange(s,{handlerIds:[i]})},[r,s]),n}function J(r,e,t){return He(e,r||(()=>({})),()=>t.reconnect())}function Q(r,e){const t=[...e||[]];return e==null&&typeof r!="function"&&t.push(r),u.useMemo(()=>typeof r=="function"?r():r,t)}function Ne(r){return u.useMemo(()=>r.hooks.dragSource(),[r])}function Ee(r){return u.useMemo(()=>r.hooks.dragPreview(),[r])}let k=!1,R=!1;class je{receiveHandlerId(e){this.sourceId=e}getHandlerId(){return this.sourceId}canDrag(){D(!k,"You may not call monitor.canDrag() inside your canDrag() implementation. Read more: http://react-dnd.github.io/react-dnd/docs/api/drag-source-monitor");try{return k=!0,this.internalMonitor.canDragSource(this.sourceId)}finally{k=!1}}isDragging(){if(!this.sourceId)return!1;D(!R,"You may not call monitor.isDragging() inside your isDragging() implementation. Read more: http://react-dnd.github.io/react-dnd/docs/api/drag-source-monitor");try{return R=!0,this.internalMonitor.isDraggingSource(this.sourceId)}finally{R=!1}}subscribeToStateChange(e,t){return this.internalMonitor.subscribeToStateChange(e,t)}isDraggingSource(e){return this.internalMonitor.isDraggingSource(e)}isOverTarget(e,t){return this.internalMonitor.isOverTarget(e,t)}getTargetIds(){return this.internalMonitor.getTargetIds()}isSourcePublic(){return this.internalMonitor.isSourcePublic()}getSourceId(){return this.internalMonitor.getSourceId()}subscribeToOffsetChange(e){return this.internalMonitor.subscribeToOffsetChange(e)}canDragSource(e){return this.internalMonitor.canDragSource(e)}canDropOnTarget(e){return this.internalMonitor.canDropOnTarget(e)}getItemType(){return this.internalMonitor.getItemType()}getItem(){return this.internalMonitor.getItem()}getDropResult(){return this.internalMonitor.getDropResult()}didDrop(){return this.internalMonitor.didDrop()}getInitialClientOffset(){return this.internalMonitor.getInitialClientOffset()}getInitialSourceClientOffset(){return this.internalMonitor.getInitialSourceClientOffset()}getSourceClientOffset(){return this.internalMonitor.getSourceClientOffset()}getClientOffset(){return this.internalMonitor.getClientOffset()}getDifferenceFromInitialOffset(){return this.internalMonitor.getDifferenceFromInitialOffset()}constructor(e){this.sourceId=null,this.internalMonitor=e.getMonitor()}}let x=!1;class Fe{receiveHandlerId(e){this.targetId=e}getHandlerId(){return this.targetId}subscribeToStateChange(e,t){return this.internalMonitor.subscribeToStateChange(e,t)}canDrop(){if(!this.targetId)return!1;D(!x,"You may not call monitor.canDrop() inside your canDrop() implementation. Read more: http://react-dnd.github.io/react-dnd/docs/api/drop-target-monitor");try{return x=!0,this.internalMonitor.canDropOnTarget(this.targetId)}finally{x=!1}}isOver(e){return this.targetId?this.internalMonitor.isOverTarget(this.targetId,e):!1}getItemType(){return this.internalMonitor.getItemType()}getItem(){return this.internalMonitor.getItem()}getDropResult(){return this.internalMonitor.getDropResult()}didDrop(){return this.internalMonitor.didDrop()}getInitialClientOffset(){return this.internalMonitor.getInitialClientOffset()}getInitialSourceClientOffset(){return this.internalMonitor.getInitialSourceClientOffset()}getSourceClientOffset(){return this.internalMonitor.getSourceClientOffset()}getClientOffset(){return this.internalMonitor.getClientOffset()}getDifferenceFromInitialOffset(){return this.internalMonitor.getDifferenceFromInitialOffset()}constructor(e){this.targetId=null,this.internalMonitor=e.getMonitor()}}function $e(r,e,t){const n=t.getRegistry(),s=n.addTarget(r,e);return[s,()=>n.removeTarget(s)]}function Le(r,e,t){const n=t.getRegistry(),s=n.addSource(r,e);return[s,()=>n.removeSource(s)]}function j(r,e,t,n){let s=t?t.call(n,r,e):void 0;if(s!==void 0)return!!s;if(r===e)return!0;if(typeof r!="object"||!r||typeof e!="object"||!e)return!1;const o=Object.keys(r),i=Object.keys(e);if(o.length!==i.length)return!1;const c=Object.prototype.hasOwnProperty.bind(e);for(let a=0;a<o.length;a++){const d=o[a];if(!c(d))return!1;const l=r[d],g=e[d];if(s=t?t.call(n,l,g,d):void 0,s===!1||s===void 0&&l!==g)return!1}return!0}function F(r){return r!==null&&typeof r=="object"&&Object.prototype.hasOwnProperty.call(r,"current")}function qe(r){if(typeof r.type=="string")return;const e=r.type.displayName||r.type.name||"the component";throw new Error(`Only native element nodes can now be passed to React DnD connectors.You can either wrap ${e} into a <div>, or turn it into a drag source or a drop target itself.`)}function ze(r){return(e=null,t=null)=>{if(!u.isValidElement(e)){const o=e;return r(o,t),o}const n=e;return qe(n),Ue(n,t?o=>r(o,t):r)}}function ee(r){const e={};return Object.keys(r).forEach(t=>{const n=r[t];if(t.endsWith("Ref"))e[t]=r[t];else{const s=ze(n);e[t]=()=>s}}),e}function V(r,e){typeof r=="function"?r(e):r.current=e}function Ue(r,e){const t=r.ref;return D(typeof t!="string","Cannot connect React DnD to an element with an existing string ref. Please convert it to use a callback ref instead, or wrap it into a <span> or <div>. Read more: https://reactjs.org/docs/refs-and-the-dom.html#callback-refs"),t?u.cloneElement(r,{ref:n=>{V(t,n),V(e,n)}}):u.cloneElement(r,{ref:e})}class We{receiveHandlerId(e){this.handlerId!==e&&(this.handlerId=e,this.reconnect())}get connectTarget(){return this.dragSource}get dragSourceOptions(){return this.dragSourceOptionsInternal}set dragSourceOptions(e){this.dragSourceOptionsInternal=e}get dragPreviewOptions(){return this.dragPreviewOptionsInternal}set dragPreviewOptions(e){this.dragPreviewOptionsInternal=e}reconnect(){const e=this.reconnectDragSource();this.reconnectDragPreview(e)}reconnectDragSource(){const e=this.dragSource,t=this.didHandlerIdChange()||this.didConnectedDragSourceChange()||this.didDragSourceOptionsChange();return t&&this.disconnectDragSource(),this.handlerId?e?(t&&(this.lastConnectedHandlerId=this.handlerId,this.lastConnectedDragSource=e,this.lastConnectedDragSourceOptions=this.dragSourceOptions,this.dragSourceUnsubscribe=this.backend.connectDragSource(this.handlerId,e,this.dragSourceOptions)),t):(this.lastConnectedDragSource=e,t):t}reconnectDragPreview(e=!1){const t=this.dragPreview,n=e||this.didHandlerIdChange()||this.didConnectedDragPreviewChange()||this.didDragPreviewOptionsChange();if(n&&this.disconnectDragPreview(),!!this.handlerId){if(!t){this.lastConnectedDragPreview=t;return}n&&(this.lastConnectedHandlerId=this.handlerId,this.lastConnectedDragPreview=t,this.lastConnectedDragPreviewOptions=this.dragPreviewOptions,this.dragPreviewUnsubscribe=this.backend.connectDragPreview(this.handlerId,t,this.dragPreviewOptions))}}didHandlerIdChange(){return this.lastConnectedHandlerId!==this.handlerId}didConnectedDragSourceChange(){return this.lastConnectedDragSource!==this.dragSource}didConnectedDragPreviewChange(){return this.lastConnectedDragPreview!==this.dragPreview}didDragSourceOptionsChange(){return!j(this.lastConnectedDragSourceOptions,this.dragSourceOptions)}didDragPreviewOptionsChange(){return!j(this.lastConnectedDragPreviewOptions,this.dragPreviewOptions)}disconnectDragSource(){this.dragSourceUnsubscribe&&(this.dragSourceUnsubscribe(),this.dragSourceUnsubscribe=void 0)}disconnectDragPreview(){this.dragPreviewUnsubscribe&&(this.dragPreviewUnsubscribe(),this.dragPreviewUnsubscribe=void 0,this.dragPreviewNode=null,this.dragPreviewRef=null)}get dragSource(){return this.dragSourceNode||this.dragSourceRef&&this.dragSourceRef.current}get dragPreview(){return this.dragPreviewNode||this.dragPreviewRef&&this.dragPreviewRef.current}clearDragSource(){this.dragSourceNode=null,this.dragSourceRef=null}clearDragPreview(){this.dragPreviewNode=null,this.dragPreviewRef=null}constructor(e){this.hooks=ee({dragSource:(t,n)=>{this.clearDragSource(),this.dragSourceOptions=n||null,F(t)?this.dragSourceRef=t:this.dragSourceNode=t,this.reconnectDragSource()},dragPreview:(t,n)=>{this.clearDragPreview(),this.dragPreviewOptions=n||null,F(t)?this.dragPreviewRef=t:this.dragPreviewNode=t,this.reconnectDragPreview()}}),this.handlerId=null,this.dragSourceRef=null,this.dragSourceOptionsInternal=null,this.dragPreviewRef=null,this.dragPreviewOptionsInternal=null,this.lastConnectedHandlerId=null,this.lastConnectedDragSource=null,this.lastConnectedDragSourceOptions=null,this.lastConnectedDragPreview=null,this.lastConnectedDragPreviewOptions=null,this.backend=e}}class Ye{get connectTarget(){return this.dropTarget}reconnect(){const e=this.didHandlerIdChange()||this.didDropTargetChange()||this.didOptionsChange();e&&this.disconnectDropTarget();const t=this.dropTarget;if(this.handlerId){if(!t){this.lastConnectedDropTarget=t;return}e&&(this.lastConnectedHandlerId=this.handlerId,this.lastConnectedDropTarget=t,this.lastConnectedDropTargetOptions=this.dropTargetOptions,this.unsubscribeDropTarget=this.backend.connectDropTarget(this.handlerId,t,this.dropTargetOptions))}}receiveHandlerId(e){e!==this.handlerId&&(this.handlerId=e,this.reconnect())}get dropTargetOptions(){return this.dropTargetOptionsInternal}set dropTargetOptions(e){this.dropTargetOptionsInternal=e}didHandlerIdChange(){return this.lastConnectedHandlerId!==this.handlerId}didDropTargetChange(){return this.lastConnectedDropTarget!==this.dropTarget}didOptionsChange(){return!j(this.lastConnectedDropTargetOptions,this.dropTargetOptions)}disconnectDropTarget(){this.unsubscribeDropTarget&&(this.unsubscribeDropTarget(),this.unsubscribeDropTarget=void 0)}get dropTarget(){return this.dropTargetNode||this.dropTargetRef&&this.dropTargetRef.current}clearDropTarget(){this.dropTargetRef=null,this.dropTargetNode=null}constructor(e){this.hooks=ee({dropTarget:(t,n)=>{this.clearDropTarget(),this.dropTargetOptions=n,F(t)?this.dropTargetRef=t:this.dropTargetNode=t,this.reconnect()}}),this.handlerId=null,this.dropTargetRef=null,this.dropTargetOptionsInternal=null,this.lastConnectedHandlerId=null,this.lastConnectedDropTarget=null,this.lastConnectedDropTargetOptions=null,this.backend=e}}function C(){const{dragDropManager:r}=u.useContext(ie);return D(r!=null,"Expected drag drop context"),r}function Be(r,e){const t=C(),n=u.useMemo(()=>new We(t.getBackend()),[t]);return T(()=>(n.dragSourceOptions=r||null,n.reconnect(),()=>n.disconnectDragSource()),[n,r]),T(()=>(n.dragPreviewOptions=e||null,n.reconnect(),()=>n.disconnectDragPreview()),[n,e]),n}function Ve(){const r=C();return u.useMemo(()=>new je(r),[r])}class Ae{beginDrag(){const e=this.spec,t=this.monitor;let n=null;return typeof e.item=="object"?n=e.item:typeof e.item=="function"?n=e.item(t):n={},n??null}canDrag(){const e=this.spec,t=this.monitor;return typeof e.canDrag=="boolean"?e.canDrag:typeof e.canDrag=="function"?e.canDrag(t):!0}isDragging(e,t){const n=this.spec,s=this.monitor,{isDragging:o}=n;return o?o(s):t===e.getSourceId()}endDrag(){const e=this.spec,t=this.monitor,n=this.connector,{end:s}=e;s&&s(t.getItem(),t),n.reconnect()}constructor(e,t,n){this.spec=e,this.monitor=t,this.connector=n}}function _e(r,e,t){const n=u.useMemo(()=>new Ae(r,e,t),[e,t]);return u.useEffect(()=>{n.spec=r},[r]),n}function Ke(r){return u.useMemo(()=>{const e=r.type;return D(e!=null,"spec.type must be defined"),e},[r])}function Xe(r,e,t){const n=C(),s=_e(r,e,t),o=Ke(r);T(function(){if(o!=null){const[c,a]=Le(o,s,n);return e.receiveHandlerId(c),t.receiveHandlerId(c),a}},[n,e,t,s,o])}function at(r,e){const t=Q(r,e);D(!t.begin,"useDrag::spec.begin was deprecated in v14. Replace spec.begin() with spec.item(). (see more here - https://react-dnd.github.io/react-dnd/docs/api/use-drag)");const n=Ve(),s=Be(t.options,t.previewOptions);return Xe(t,n,s),[J(t.collect,n,s),Ne(s),Ee(s)]}function Ze(r){return u.useMemo(()=>r.hooks.dropTarget(),[r])}function Ge(r){const e=C(),t=u.useMemo(()=>new Ye(e.getBackend()),[e]);return T(()=>(t.dropTargetOptions=r||null,t.reconnect(),()=>t.disconnectDropTarget()),[r]),t}function Je(){const r=C();return u.useMemo(()=>new Fe(r),[r])}function Qe(r){const{accept:e}=r;return u.useMemo(()=>(D(r.accept!=null,"accept must be defined"),Array.isArray(e)?e:[e]),[e])}class et{canDrop(){const e=this.spec,t=this.monitor;return e.canDrop?e.canDrop(t.getItem(),t):!0}hover(){const e=this.spec,t=this.monitor;e.hover&&e.hover(t.getItem(),t)}drop(){const e=this.spec,t=this.monitor;if(e.drop)return e.drop(t.getItem(),t)}constructor(e,t){this.spec=e,this.monitor=t}}function tt(r,e){const t=u.useMemo(()=>new et(r,e),[e]);return u.useEffect(()=>{t.spec=r},[r]),t}function rt(r,e,t){const n=C(),s=tt(r,e),o=Qe(r);T(function(){const[c,a]=$e(o,s,n);return e.receiveHandlerId(c),t.receiveHandlerId(c),a},[n,e,s,t,o.map(i=>i.toString()).join("|")])}function ct(r,e){const t=Q(r,e),n=Je(),s=Ge(t.options);return rt(t,n,s),[J(t.collect,n,s),Ze(s)]}const nt=r=>(e,t)=>{const n=t();return new Promise(async s=>{const o=ae(),i=ce({...r,instrumentId:o.id});e(ue(i)),e(de(i));const c=r!=null&&r.instrumentId?le(n,r.instrumentId):void 0;e(ge(i,{oldInstrument:c})),s(i.id)})},ut=()=>(r,e)=>new Promise(async t=>{const n=e(),s=he(n);if(!s)return;const o=A(s)?s.id:s.parentId;t(r(nt({parentId:o})))}),st=(r,e,t)=>(n,s)=>{const o=s(),i=De(o,r);if(!i)return;const c={...i,parentId:e};n(me(c)),n(Te({id:r,parentId:e,index:t}))},dt=(r,e)=>(t,n)=>{const s=n(),o=fe(s,r);o&&t(pe({instrumentId:o.id,update:{key:e}}))},lt=r=>(e,t)=>{const{dragId:n,hoverId:s}=r,o=t(),i=Ie(o),c=y(o,n),a=y(o,s);if(!c||!a)return!1;const d=a.parentId?i[a.parentId]:null,l=P(c),g=P(a);if(!l&&g){const p=d==null?void 0:d.trackIds.indexOf(a.id);return p===void 0||p===-1?!1:(e(H({id:c.id,index:p})),!0)}const f=c.parentId?N(o,c.parentId):null,h=a.parentId?N(o,a.parentId):null;if(!f||!h)return!1;if(f.id===h.id){const p=i[f.id].trackIds.indexOf(a.id);e(H({id:c.id,index:p}))}return!1},gt=r=>(e,t)=>{const n=t(),s=$(n),o=N(n,r==null?void 0:r.parentId),i=E(s,o==null?void 0:o.scaleId),a=((i==null?void 0:i.notes)??Se).map((l,g)=>({degree:g,offset:0})),d=Ce({name:we,notes:a});return new Promise(async l=>{const g=ve({...r,scaleId:d.id});e(Oe(d)),e(ye(g)),e(Pe(g)),l(g.id)})},ht=(r,e)=>(t,n)=>{const s=n(),o=_(s),i=o[r];if(!i)return;const c=$(s),a=E(c,i.scaleId),d=K(a);if(!a)return;const l=E(o,i==null?void 0:i.parentId),g=X(l,o,c),f=Z(g);if(!(f!=null&&f.length))return;const h=d.at(0),p=(h==null?void 0:h.offset)||0,L=(h==null?void 0:h.degree)||0,w=B(g,h),m=d.at(-1),q=(m==null?void 0:m.offset)||0,z=(m==null?void 0:m.degree)||0,b=B(g,m),te=S.toPitchClass(e),U=S.closestPitchClass(te,f);if(!U)return;const I=f.findIndex(O=>S.toPitchClass(O)===U);if(I<0)return;const re=f[I];let v=S.OctaveDistance(re,e)*12;(b-w>12||e-w>12||b-e>12)&&(b-e>12?I<z&&I<L?v=p+12:v=p:e-w>12&&(I>L&&I>z?v=q-12:v=q));const ne={degree:I,offset:v},W=[...d];W.splice(I,0,ne);const se=be.uniqBy(W,"degree").sort((O,Y)=>O.degree+O.offset*12-(Y.degree+Y.offset*12));t(G({id:a.id,notes:se}))},ft=(r,e)=>(t,n)=>{const s=n(),o=_(s),i=o[r];if(!i||!A(i))return;const c=$(s),a=c[i.scaleId],d=K(a);if(!a)return;const l=X(i,o,c),g=Z(l),f=S.toPitchClass(e),h=g.findIndex(p=>S.toPitchClass(p)===f);h<0||(d.splice(h,1),t(G({id:a.id,notes:d})))},pt=r=>(e,t)=>{const{dragId:n,hoverId:s}=r,o=t(),i=y(o,n),c=y(o,s);if(!i||!c)return!1;const a=P(i),d=P(c);if(a&&!d){const l=i.id,g=c.id;return e(st(l,g)),!0}return e(H({id:i.id,index:0})),!0};function It(r){const{targetId:e}=r,[t,n]=u.useState(!1),[s,o]=u.useState({x:0,y:0}),i=u.useRef(null);u.useEffect(()=>{const a=l=>{const g=document.getElementById(e);if(g&&g.contains(l.target)){l.preventDefault(),n(!0),o({x:l.clientX,y:l.clientY-58});return}i.current&&!i.current.contains(l.target)&&n(!1)},d=l=>{i.current&&!i.current.contains(l.target)&&n(!1)};return document.addEventListener("contextmenu",a),document.addEventListener("click",d),()=>{document.removeEventListener("contextmenu",a),document.removeEventListener("click",d)}},[e]),Me.useHotkeys("escape",()=>n(!1)),u.useLayoutEffect(()=>{const a=i.current;a&&(s.x+a.offsetWidth>window.innerWidth&&o({...s,x:s.x-a.offsetWidth}),s.y+a.offsetHeight>window.innerHeight&&o({...s,y:s.y-a.offsetHeight}))},[s]);const c=u.useCallback((a,d)=>M("li",{className:`px-3 py-1 ${typeof a.label=="string"?`${a.disabled?"text-slate-500 cursor-default":"text-slate-200 cursor-pointer hover:bg-slate-700"}`:null} ${a.divideEnd?"mb-1 border-b border-b-slate-500":""}`,onClick:a.disabled?()=>null:a.onClick,children:a.label},typeof a.label=="string"?a.label:`option-${d}`),[]);return M("div",{ref:i,className:`absolute flex flex-col items-center bg-slate-900/80 border border-slate-50/50 py-2 rounded-lg drop-shadow-2xl z-[100] font-nunito font-light ${r.className??""} backdrop-blur-lg text-sm`,onClick:()=>n(!1),style:{left:s.x,top:s.y,opacity:t?1:0,transform:`scale(${t?1:.8})`,transition:"opacity 100ms ease-in-out, transform 100ms ease-in-out",pointerEvents:t?"all":"none"},children:M("ul",{children:r.options.map(c)})})}export{It as C,ct as a,ht as b,gt as c,nt as d,pt as e,ut as f,lt as m,ft as r,dt as s,at as u};
